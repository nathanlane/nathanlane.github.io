<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <base href="">
    <title>Building a Dataset from UN Comtrade's API - Nathan Lane - nathanlane.github.io</title>
    <meta name="author" content="Dr. Nathan Lane">
    <meta name="description" content="The personal webpage of Assistant Professor/Lecturer, Nathaniel Lane.">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Karla:300,400,700">
</head>
<body>

<header class="block block-header-1">

  <div class="block-header-1--logo">
  <a href="http://nathanlane.info">Nathanlane.info</a>
  </div>

  <div class="block-header-1--nav">
    <ul>
      
      <li class="nav-item "><a href="">Main</a></li>
      
      <li class="nav-item "><a href="http://nathanlane.info/blog">Blog</a></li>
      
      <li class="nav-item "><a href="https://www.dropbox.com/s/2xgg325wwayo9s9/NathanLane_IIES_20172018.pdf?dl=0">CV</a></li>
      
    </ul>
  </div>

</header>

<section class="post--content">
	<section class="block block-one-column-1">
	  <div class="container">
	    <div class="columns">
	      <div class="column">

			  <h1>Building a Dataset from UN Comtrade's API</h1>
			  <p></p>

			  <p>The following is a simple program for building data sets using the United Nation’s COMTRADE API.</p>

<p>Note: this code does not apply to the “Bulk download” API, which allows users to download entire chunks of annual or monthly data. Instead, this program is for making specific, repeated queries for import (export) data between certain countries.</p>

<h4 id="1-first-things-first-some-prepation">1. First Things First: Some Prepation.</h4>

<p>My script loops over lists of reporting countries and their counterparts.
I have these lists saved as CSV files.</p>

<p>The UN Comtrade system uses its own coding scheme. Thus, we do not make queries based on country names, but using their identifiers found here <a href="https://unstats.un.org/unsd/tradekb/Knowledgebase/Comtrade-Country-Code-and-Name" target="_blank">coding scheme</a>.</p>

<p>I have list of countries and their corresponding codes saved as .csv files. I have a trade partner list (uncomtrade_partners.csv) and list of reporting countries (uncomtrade_reporting.csv), both of which have the following layout:</p>

<div>
<img src="/assets/comtradelist.png" />
</div>

<p>The countries I wish to query have a column (data.frame$V3) with a 1 indicating the country I wish to include in my query.</p>

<p>The following code sets takes these .csv files, and creates two lists of UN COMTRADE codes that correspond to the reporting countries I want and the partner countries I want.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## TOP MATTER</span><span class="w">

</span><span class="c1"># Libraries.</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rjson</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RCurl</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rvest</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span><span class="w">

</span><span class="c1"># A directory where we save things.</span><span class="w">
</span><span class="o">/</span><span class="n">your</span><span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">path</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">project_directory</span><span class="w">


</span><span class="c1">## PREPARE COUNTRY LISTS  </span><span class="w">

</span><span class="c1"># Deal with partner country list.</span><span class="w">
</span><span class="s2">"uncomtrade_partners.csv"</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">file.path</span><span class="p">(</span><span class="w"> </span><span class="n">codelist_path</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">read.csv</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">partners_dummies</span><span class="w">

</span><span class="c1"># Get partner list.</span><span class="w">
</span><span class="n">partners_dummies</span><span class="p">[</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="w"> </span><span class="n">partners_dummies</span><span class="o">$</span><span class="n">V</span><span class="m">3</span><span class="o">==</span><span class="m">1</span><span class="w"> </span><span class="p">),]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">.</span><span class="o">$</span><span class="n">V</span><span class="m">1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">as.vector</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">partners_slist</span><span class="w">

</span><span class="c1"># Deal with reporting country list.</span><span class="w">
</span><span class="s2">"uncomtrade_reporting.csv"</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">file.path</span><span class="p">(</span><span class="w"> </span><span class="n">codelist_path</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">read.csv</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">reporting_dummies</span><span class="w"> 

</span><span class="c1"># Get reporting country list</span><span class="w">
</span><span class="n">reporting_dummies</span><span class="p">[</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="w"> </span><span class="n">reporting_dummies</span><span class="o">$</span><span class="n">V</span><span class="m">3</span><span class="o">==</span><span class="m">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">,]</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">.</span><span class="o">$</span><span class="n">V</span><span class="m">1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">as.vector</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">reporting_list</span></code></pre></figure>

<h4 id="2-the-meat-querying-and-saving-data-chunks">2. The Meat: Querying and Saving Data Chunks</h4>

<p>Next I define two programs.</p>

<p>The first program is a file for retreiving the UN COMTRADE data in (.csv) form from the <a href="https://comtrade.un.org/data/doc/api/" target="_target">UN COMTRADE’s bulk download API</a>.</p>

<p>The following code is based loosely on <a href="https://comtrade.un.org/data/doc/api/" target="_target">COMTRADE’s own R code</a></p>

<p>One important distiction between this code and mine is that I found that on non-Windows computers, the UN’s code didn’t handle HTTPS very well. In fact, using their code I tended to get connection errors, in particular,</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Error</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">curl</span><span class="o">::</span><span class="n">curl_fetch_memory</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> 
 </span><span class="n">Peer</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">authenticated</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">CA</span><span class="w"> </span><span class="n">certificates</span><span class="w">  </span></code></pre></figure>

<p>Yup, an HTTPS related error.</p>

<p>Thus, the line <code>set_config( config( ssl_verifypeer = 0L ) )</code> deals with R’s HTTPS issues (<a href="https://www.r-bloggers.com/fixing-peer-certificate-cannot-be-authenticated/" target="_target">As reported here</a>).</p>

<p>Finally, <code>read.csv( text = content( GET(string), as="text" , type = "text/csv" , header = TRUE ))</code> <em>properly</em> retrieves a concatenated HTTPS URL stored in the <code>string</code>, and parsing the retrieved text content into a coherent .CSV table. (The function deals with .JSON-based queries in similar ways, but I just prefer .CSV data.)</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## PROGRAM 1. GET DATA FROM THE UN COMTRADE API.</span><span class="w">

</span><span class="c1"># First deal with HTTPS.</span><span class="w">
</span><span class="n">httr</span><span class="o">::</span><span class="n">set_config</span><span class="p">(</span><span class="w"> </span><span class="n">config</span><span class="p">(</span><span class="w"> </span><span class="n">ssl_verifypeer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0L</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="c1"># Define UN COMTRADE RETRIEVAL FUNCTION.</span><span class="w">
</span><span class="n">get.Comtrade</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="w"> </span><span class="n">url</span><span class="o">=</span><span class="s2">"https://comtrade.un.org/api/get?"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">maxrec</span><span class="o">=</span><span class="m">50000</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"C"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="o">=</span><span class="s2">"A"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="o">=</span><span class="s2">"HS"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="o">=</span><span class="s2">"now"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">rg</span><span class="o">=</span><span class="s2">"all"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="o">=</span><span class="s2">"TOTAL"</span><span class="w">
                          </span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s2">"json"</span><span class="w"> </span><span class="p">)</span><span class="w">
  
</span><span class="p">{</span><span class="w">
  
  </span><span class="c1"># Tell us where we are.</span><span class="w">
  </span><span class="n">paste</span><span class="p">(</span><span class="w"> </span><span class="s2">"Querying reporting country"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> 
         </span><span class="s2">"trade with"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">,</span><span class="w"> 
         </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" "</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">print</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># The URL string constructed from function arguments.</span><span class="w">
  </span><span class="n">string</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">url</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"max="</span><span class="p">,</span><span class="n">maxrec</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#maximum no. of records returned</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"type="</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#type of trade (c=commodities)</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"freq="</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#frequency</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"px="</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#classification</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"ps="</span><span class="p">,</span><span class="n">ps</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#time period</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"r="</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#reporting area</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"p="</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#partner country</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"rg="</span><span class="p">,</span><span class="n">rg</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#trade flow</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"cc="</span><span class="p">,</span><span class="n">cc</span><span class="p">,</span><span class="s2">"&amp;"</span><span class="w"> </span><span class="c1">#classification code</span><span class="w">
                  </span><span class="p">,</span><span class="s2">"fmt="</span><span class="p">,</span><span class="n">fmt</span><span class="w"> </span><span class="c1">#Format</span><span class="w">
                  </span><span class="p">,</span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># How to process .csv OR the .json data.</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"csv"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    
    </span><span class="c1"># Read.csv.</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="w"> </span><span class="n">GET</span><span class="p">(</span><span class="n">string</span><span class="p">),</span><span class="w"> 
                                      </span><span class="n">as</span><span class="o">=</span><span class="s2">"text"</span><span class="w"> </span><span class="p">,</span><span class="w">  
                                      </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/csv"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                                      </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="p">))</span><span class="w">
    
    </span><span class="c1"># Make dataset into datatable. </span><span class="w">
    </span><span class="n">save.Comtrade</span><span class="p">(</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">)</span><span class="w"> 
    
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    
    </span><span class="k">if</span><span class="p">(</span><span class="n">fmt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"json"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      
      </span><span class="c1"># Access URL properly and retrieve JSON.</span><span class="w">
      </span><span class="n">retrieved_url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="w"> </span><span class="n">GET</span><span class="p">(</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">as</span><span class="w"> </span><span class="o">=</span><span class="s2">"text"</span><span class="w"> </span><span class="p">,</span><span class="w">
                                  </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/html"</span><span class="w"> </span><span class="p">)</span><span class="w">
      </span><span class="n">raw.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="w"> </span><span class="n">retrieved_url</span><span class="w"> </span><span class="p">)</span><span class="w">
      
      </span><span class="c1"># Turn into dataframe</span><span class="w">
      </span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="w"> </span><span class="n">raw.data</span><span class="w"> </span><span class="p">)</span><span class="w">
      </span><span class="n">colnames</span><span class="p">(</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">)</span><span class="w">
       
      </span><span class="c1"># Make dataset into datatable. </span><span class="w">
      </span><span class="n">save.Comtrade</span><span class="p">(</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">)</span><span class="w"> 
      
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The second program simply saves each date query.</p>

<p>Specifically, within the <code>get.Comtrade()</code> function above, we dumped our queried .CSV tables into a local directory. (As opposed to holding them in memory, given R’s funky memory issues). This was done using our function, <code>save.Comtrade()</code>, which takes an individual data.frame and saves it using <code>write.csv()</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## PROGRAM 2. SAVE PREPARED DATA.FRAME AS CSV.</span><span class="w">

</span><span class="c1"># Path for raw UN comtrade queries.</span><span class="w">
</span><span class="n">file.path</span><span class="p">(</span><span class="w"> </span><span class="n">working_path</span><span class="w"> </span><span class="p">,</span><span class="w"> 
           </span><span class="s2">"data"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
           </span><span class="s2">"uncomtradequeries"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">rawcomtrade_path</span><span class="w">

  
</span><span class="c1">## ... Takes argumenents from main function get.Comtrade</span><span class="w">
</span><span class="n">save.Comtrade</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="w"> </span><span class="n">dataset_argument</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">){</span><span class="w">
  
  </span><span class="c1"># Prepare file name, pass to fast writing CSV method.</span><span class="w">
  </span><span class="n">paste</span><span class="p">(</span><span class="w"> </span><span class="s2">"trade"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
          </span><span class="n">px</span><span class="w"> </span><span class="p">,</span><span class="w"> 
          </span><span class="n">ps</span><span class="p">,</span><span class="w"> 
          </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> 
          </span><span class="n">p</span><span class="w"> </span><span class="p">,</span><span class="w"> 
          </span><span class="s2">"raw.csv"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
          </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"_"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">filename</span><span class="w">
  
  </span><span class="c1"># Tell us where we are.</span><span class="w">
  </span><span class="n">paste</span><span class="p">(</span><span class="w"> </span><span class="s2">"Saving dataset for reporting country"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">,</span><span class="w"> 
         </span><span class="s2">"trade with"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">,</span><span class="w"> 
         </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" "</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">print</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Concatenate the project directory and filename.</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">file.path</span><span class="p">(</span><span class="w"> </span><span class="n">project_directory</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">

    </span><span class="c1"># Save the dataset as a CSV.</span><span class="w">
    </span><span class="n">write.csv</span><span class="p">(</span><span class="w"> </span><span class="n">dataset_argument</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">)</span><span class="w">  
  
</span><span class="p">}</span></code></pre></figure>

<h4 id="3-making-multiple-queries-using-mapply">3. Making Multiple Queries Using mapply()</h4>

<p>The <code>mapply()</code> function runs the <code>get.Comtrade()</code> UN COMTRADE retrieval program, doing so for each combination of countries from the <strong>reporting_list</strong> and the <strong>partners_list</strong> generated in Part 1 – holding a list of parameters constant with <code>MoreArgs</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## EXECUTE QUERY FOR ALL COUNTRY PAIRS.</span><span class="w">

</span><span class="c1"># Build array (actually, data.frame) of arguments for function:</span><span class="w">
</span><span class="n">argument_array</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="w"> </span><span class="n">partner_arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partners_list</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                               </span><span class="n">reporting_arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reporting_list</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="c1"># Show arguments array:</span><span class="w">
</span><span class="n">argument_array</span><span class="w">


</span><span class="c1"># Take multiple arguments and apply the function.</span><span class="w">
</span><span class="n">mapply</span><span class="p">(</span><span class="w"> </span><span class="n">get.Comtrade</span><span class="w"> </span><span class="p">,</span><span class="w">
        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argument_array</span><span class="o">$</span><span class="n">reporting_arguments</span><span class="w"> </span><span class="p">,</span><span class="w">
        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argument_array</span><span class="o">$</span><span class="n">partner_arguments</span><span class="w"> </span><span class="p">,</span><span class="w"> 
        </span><span class="n">MoreArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"all"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                         </span><span class="n">fmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"csv"</span><span class="w"> </span><span class="p">,</span><span class="w">
                         </span><span class="n">rg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                         </span><span class="n">px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"h0"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                         </span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"all"</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>Again, <code>mapply()</code> is like a loop, applying the API querying function to each reporting+partner country combination. However, we cannot directly use the <em>reporting_list</em> and the <em>partners_list</em> as the two argument lists in <code>mapply()</code> (doing so won’t generate a complete list of combinations). Instead, we use the <code>expand.grid()</code> function to generate all reporting+partner country combinations; and this table gives us two columns, <code>argument_array$reporting_arguments</code> and <code>argument_array$partner_arguments</code>, which are the actual country argument lists used by <code>mapply()</code>.</p>

<p>While <code>mapply()</code>’s main value added is cycling over many argument lists, we want to hold some <code>get.Comtrade()</code> arguments constant. To do so, we supply a list of arguments to <code>MoreArgs</code>. The parameters we hold costant are in the list, <code>list( ps = "all" , fmt = "csv" , rg = "1" , px = "h0" , cc = "all")</code>.</p>

<h4 id="4-stacking-saved-data-chunks-into-a-dataset">4. Stacking Saved Data Chunks into a Dataset</h4>

<p>Together, <code>mapply()</code> and <code>get.Comtrade()</code> repeatedly queried and saved each chunk of queried data to a directory . However, 100s of data chunks are hardly useful as a dataset. We was to assemble the pieces into a single coherent dataset.</p>

<p>Thus, the following program assembles our saved queries into a coherent dataset.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## MAKE DATASET OUT OF ALL SAVED FILES</span><span class="w">

</span><span class="c1">## Make list of files we saved locally to the project path.</span><span class="w">
</span><span class="n">csvfile_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">project_directory</span><span class="w"> </span><span class="p">,</span><span class="w">
                            </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trade_h0.*.csv"</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                            </span><span class="n">all.files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w"> </span><span class="p">,</span><span class="w">
                            </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="p">,</span><span class="w"> 
                            </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="c1"># Lapply the rest of the files to the main.dt file 1.</span><span class="w">
</span><span class="n">lapply</span><span class="p">(</span><span class="w"> </span><span class="n">csvfile_list</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">fread</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">","</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">rbindlist</span><span class="p">(</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">main.dt</span><span class="w">


</span><span class="c1"># Save the stacked CSV.</span><span class="w">
</span><span class="n">write.csv</span><span class="p">(</span><span class="w"> </span><span class="n">main.dt</span><span class="w"> </span><span class="p">,</span><span class="w"> 
           </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="w"> </span><span class="n">project_directory</span><span class="w"> </span><span class="p">,</span><span class="w"> 
           </span><span class="s2">"thebigdataset.csv"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span></code></pre></figure>

<p>The above code makes a list of all the files in <em>/your/file/path</em> that match our naming scheme, <code>_trade_h0_all_[REPORTING COUNTRY]_[PARTNER COUNTRY]_raw.csv_</code>.</p>

<p>Next, we efficiently open all these files and stack them into a coherent dataset. We use <code>lapply()</code> to loop over the list of .csv files and open each using nimble <code>fread()</code> function (from the wonderful __data.table package). The list of opened datasets are then “stacked” into a single dataset using <code>rbindlist()</code>.</p>

<p>Finally, we we save the assembled dataset to our local direction, <em>/your/file/path</em>. You can use your preferred method of course, especially if you run into memory problems writing large .CSV files with R (I prefer using the experimental<code>fwrite()</code> function in the data.table package, <strong><a href="http://nathanlane.info/tutorial/2017/03/31/writingwithfwrite.html">which I discuss here</a>.</strong>).</p>


			  <br>
			   <p class="post--date">19 Apr 2017</p>

	      </div>        
	    </div>
	  </div>
	</section>
</section>

<footer class="block block-footer-1">
  <div class="container">
    <p><a href="mailto:nathaniel.lane@gmail.com" title=""><strong>nathaniel.lane@monash.edu</strong></a> <span class="box"> • </span>Nathan Lane, 2014-2018 <span class="box"> • None of this garbage reflects my institution.</span></p>
  </div>
</footer>

  </body>
</html>
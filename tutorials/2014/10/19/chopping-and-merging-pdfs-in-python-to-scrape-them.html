<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <base href="">
    <title>Tutorial: Manipulating PDFs in Python (to Scrape Them). - Nathan Lane - nathanlane.github.io</title>
    <meta name="author" content="Dr. Nathan Lane">
    <meta name="description" content="The personal webpage of Assistant Professor/Lecturer, Nathaniel Lane.">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Karla:300,400,700">
</head>
<body>

<header class="block block-header-1">

  <div class="block-header-1--logo">
  <a href="http://nathanlane.info">Nathanlane.info</a>
  </div>

  <div class="block-header-1--nav">
    <ul>
      
      <li class="nav-item "><a href="">Main</a></li>
      
      <li class="nav-item "><a href="http://nathanlane.info/blog">Blog</a></li>
      
      <li class="nav-item "><a href="https://www.dropbox.com/s/2xgg325wwayo9s9/NathanLane_IIES_20172018.pdf?dl=0">CV</a></li>
      
    </ul>
  </div>

</header>

<section class="post--content">
	<section class="block block-one-column-1">
	  <div class="container">
	    <div class="columns">
	      <div class="column">

			  <h1>Tutorial: Manipulating PDFs in Python (to Scrape Them).</h1>
			  <p></p>

			  <p>When digitizing old data, we often start with a pile of scanned documents we must reorganize. Much time is spent manually trudging through scans, deducing what variables exist, and selecting the tables we eventually wish to turn into machine-readable data. When you have hundreds of multi-page PDFS, this can be a painful experience. However, automating PDF manipulation with Python can save major time.</p>
<h3>The Problem</h3>
<p>We start with scans of old, provincial statistical yearbooks for a Southeast Asian country.</p>
<p>Each yearbook page corresponds to a variable we want: page 1 has land statistics, page 2 has rice statistics, page 3 irrigation, etc..</p>
<p>We want to reorganize this stack of yearbooks into something that is easier to digitize and organized by variable, not province. In essence (to the data scientist) we need to "reshape" our scanned PDF data.</p>
<p>To restate the problem:</p>
<ul>
<li>
<h4>Have: Province x Variable PDFs</h4>
<p>Most old historical data comes in the following format: hard copy volumes organized by province, state, region, etc., each with the same set of tables (<em>cough</em> variables).</li>
<li>
<h4>Need: Variable x Province PDFs</h4>
<p>And most of the time we want to pull certain pages from each geographic volume and create a new document for each variable.</li>
</ul>
<h3>The Code</h3>
<p>The following is written for Python 3.* and uses the <strong><a title="pyPDF2" href="https://pypi.python.org/pypi/PyPDF2" target="_blank">PyPDF2 package</a></strong> (which is a <strong><a title="PyPdf" href="http://pybrary.net/pyPdf/" target="_blank">fork of the original PyPdf package</a></strong>), as well as the <code>OS</code> module for directory manipulation.</p>
<p>The code starts with a directory containing our multi-page PDFs and creates a sub-folder to store individual pages, <code>/splits.</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#The only two modules you need:</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="kn">import</span> <span class="n">PdfFileReader</span><span class="p">,</span> <span class="n">PdfFileWriter</span><span class="p">,</span> <span class="n">PdfFileMerger</span>

<span class="c">#The directory of your (multipage) PDF files.</span>
<span class="n">start_dir</span> <span class="o">=</span> <span class="s">"/our/working/path"</span> <span class="c"># Main working directory with PDFs to chop/clean</span>

<span class="c">#Make the following dirs if it doesn't exist.</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">start_dir</span><span class="p">,</span> <span class="s">"splits1"</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span></code></pre></figure>


<p>Second, our stack-o-PDFs are read, chopped, and their pages are placed in (page) numbered folders.</p>
<p>The following code chunk begins at the <code>/start_dir</code>, the file containing our original PDF files. We read each scan and then loop over its pages with the line, <code>for i in xrange(in_file_pdf.numPages)</code>. Each page <code>i</code> is saved to a variable folder, corresponding to its page number: first pages are saved in <code>start_dir/splits/1</code>; second pages, into <code>start_dir/splits/2</code> folder, etc..</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">start_dir</span><span class="p">):</span>
    <span class="c">#Run the following on PDFs only.</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.pdf'</span><span class="p">):</span>
    <span class="c">#Show current multi-page PDF.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Splitting "</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>

        <span class="c">#Define input files, paths.</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">start_dir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">in_file_pdf</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">))</span> <span class="c">#(be explicit about binary file)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">in_file_pdf</span><span class="o">.</span><span class="n">numPages</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">PdfFileWriter</span><span class="p">()</span>

            <span class="c">#Make subfolder for each page, but only once.</span>
            <span class="n">num_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">num_path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">num_path</span><span class="p">)</span>

            <span class="c">#Add i page to output, define output path, save, close outputstream.</span>
            <span class="n">output</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">in_file_pdf</span><span class="o">.</span><span class="n">getPage</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">out_file_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">".pdf"</span> <span class="c">#Add i number to new name.</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">out_file_pdf</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Saving "</span><span class="o">+</span><span class="n">out_file</span><span class="p">)</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputStream</span><span class="p">)</span>
            <span class="n">outputStream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>Third, after chopping and saving, we combine the separated pages into variable-based PDFs.</p>
<p>The following code loops over each page folder (<code>/splits/1</code>, <code>/splits/2</code>,<code>...</code>). Using pyPDF2's <code>PdfFilerMerge </code>function, we combine pages within each folder into a single PDF file.</p>
<p>Hence, the first page of each provincial yearbook is combined into a new file (i.e. the pages in <code>/splits/1</code> become 1.pdf), which we can then scrape/digitize/pre-process/whatever.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="n">merger</span> <span class="o">=</span> <span class="n">PdfFileMerger</span><span class="p">()</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">in_file_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">in_file_pdf</span><span class="p">)</span>
            <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PdfFileReader</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">in_file_pdf</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)))</span>

        <span class="n">out_file_pdf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="o">+</span><span class="s">".pdf"</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">out_file_pdf</span><span class="p">)</span>
        <span class="n">outputStream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputStream</span><span class="p">)</span>
        <span class="n">outputStream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>Importantly, your project will probably look much different from this, but combining the <code>OS module</code> with the <code>pyPDF2 package</code> in Python can make many splitting/merging tasks trivial. Digitizing old data often entails mind-numbing file manipulation, so a little Python can go a long way.</p>


			  <br>
			   <p class="post--date">19 Oct 2014</p>

	      </div>        
	    </div>
	  </div>
	</section>
</section>

<footer class="block block-footer-1">
  <div class="container">
    <p><a href="mailto:nathaniel.lane@gmail.com" title=""><strong>nathaniel.lane@monash.edu</strong></a> <span class="box"> • </span>Nathan Lane, 2014-2018 <span class="box"> • None of this garbage reflects my institution.</span></p>
  </div>
</footer>

  </body>
</html>